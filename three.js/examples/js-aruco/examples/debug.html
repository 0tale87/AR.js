<html>
<!-- <script src='vendor/Three.js'></script>  -->
<script src='../../vendor/three.js/build/three.js'></script> 

<script src='../vendor/js-aruco/src/svd.js'></script> 
<script src='../vendor/js-aruco/src/posit1.js'></script> 
<!-- <script src='../vendor/js-aruco/src/posit2.js'></script>  -->
<script src='../vendor/js-aruco/src/cv.js'></script> 
<script src='../vendor/js-aruco/src/aruco.js'></script> 


<script src='../threex-aruco.js'></script> 


<body style='background-color: darkgray;'>
        
        <canvas id='canvas' style='width: 320px; height: 240px;'></canvas>
        <div id='webGLContainer' style='width: 320px; height: 240px; display: inline;'></div>
        
        <style media="screen">
        img {
                width: 256px;
                height: 256px;
                padding: 8em;
        }
        </style>
        <br/>
        <div>
                <!-- <img src="images/1001.png"/> -->
                <img src="images/1001.png"/>
        </div>
        
        <script>
        var markerSize = 1.0; //millimeters
        
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        
        var videoElement = document.createElement('video')
        // videoElement.width = 320
        // videoElement.height = 240
        videoElement.autoplay = true
        
        var canvas = document.getElementById('canvas');
        
        canvas.width = 320;
        canvas.height = 240;
        
        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////
        
        navigator.getUserMedia({video:true}, function (stream){
                        if (window.URL) {
                                videoElement.src = window.URL.createObjectURL(stream);
                        } else if (videoElement.mozSrcObject !== undefined) {
                                videoElement.mozSrcObject = stream;
                        } else {
                                videoElement.src = stream;
                        }
                },
                function(error){
                }
        );
        
        var detector = new AR.Detector();
        var posit = new POS.Posit(markerSize, canvas.width);
        
        var renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(0xffffff, 1);
        renderer.setSize(canvas.width, canvas.height);
        document.getElementById('webGLContainer').appendChild(renderer.domElement);
        
        var sceneOrtho = new THREE.Scene();
        var cameraOrtho = new THREE.OrthographicCamera(-0.5, 0.5, 0.5, -0.5);
        sceneOrtho.add(cameraOrtho);
        
        var scenePersp = new THREE.Scene();
        var cameraPersp = new THREE.PerspectiveCamera(42, canvas.width / canvas.height, 0.01, 100);
        scenePersp.add(cameraPersp);
        
        //////////////////////////////////////////////////////////////////////////////
        //                Code Separator
        //////////////////////////////////////////////////////////////////////////////
        
        
        var videoTexture = new THREE.Texture(videoElement)
        videoTexture.minFilter = THREE.LinearFilter
        var geometry = new THREE.PlaneGeometry(1.0, 1.0)
        var material = new THREE.MeshBasicMaterial({
                map: videoTexture, 
                depthTest: false, 
                depthWrite: false
        })
        var videoMesh = new THREE.Mesh(geometry, material);
        videoMesh.position.z = -1;
        sceneOrtho.add(videoMesh);
        
        
        var geometry = new THREE.PlaneGeometry(1.0, 1.0, 10, 10)
        var material = new THREE.MeshBasicMaterial( {
                color: 'hotpink',
                wireframe: true
        } )
        var model = new THREE.Mesh(geometry, material);
        
        var arWorldRoot = new THREE.Group
        arWorldRoot.add(model)
        scenePersp.add(arWorldRoot);
        
        //////////////////////////////////////////////////////////////////////////////
        //                render loop
        //////////////////////////////////////////////////////////////////////////////
        var lastDetectionAt = null
        requestAnimationFrame(function onAnimationFrame(){
                requestAnimationFrame(onAnimationFrame);
                
                // update videoMesh
                videoMesh.material.map.needsUpdate = true;
                
                var present = Date.now()/1000
                if( lastDetectionAt === null || present-lastDetectionAt >= 1/30){
                        lastDetectionAt = Date.now()/1000
                // if( videoElement.readyState >= videoElement.HAVE_CURRENT_DATA ){
// console.log('ddd')
                        
                        var context = canvas.getContext('2d');
                        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                        imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        
                        var detectedMarkers = detector.detect(imageData);
                        
                        // compute the pose for each detectedMarkers
                        detectedMarkers.forEach(function(detectedMarker){
                                // debugger
                                var markerCorners = detectedMarker.corners;

                                // convert the corners
                                var poseCorners = new Array(markerCorners.length)
                                for (var i = 0; i < markerCorners.length; ++ i){
                                        var markerCorner = markerCorners[i];        
                                        poseCorners[i] = {
                                                x:  markerCorner.x - (canvas.width / 2),
                                                y: -markerCorner.y + (canvas.height/ 2)
                                        }
                                }
                                
                                // estimate pose from corners
                                detectedMarker.pose = posit.pose(poseCorners);
                        })
                        

                        if (detectedMarkers.length > 0){
                                var detectedMarker = detectedMarkers[0]
                                
                                THREEx.Aruco.updateObject3D(arWorldRoot, detectedMarker.pose.bestRotation, detectedMarker.pose.bestTranslation);
                        }                

                        THREEx.Aruco.drawDebugCorners(canvas, detectedMarkers);
                        THREEx.Aruco.drawDebugId(canvas, detectedMarkers);

                }
                
                // render scene
                renderer.autoClear = false;
                renderer.clear();
                renderer.render(sceneOrtho, cameraOrtho);
                renderer.render(scenePersp, cameraPersp);
        });
        
        
        
        </script>        
</body>
</html>
